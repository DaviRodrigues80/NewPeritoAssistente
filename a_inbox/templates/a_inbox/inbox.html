{% extends "layouts/d.html" %}
{% load static %}

{% block content %}
<div x-data="{ modal_open: false }" class="container mx-auto flex flex-col md:flex-row py-6 space-y-6 md:space-y-0 md:space-x-6">

    <!-- Conversations List -->
    <div class="w-full md:w-1/3 bg-white shadow-lg rounded-lg p-4">
        <button @click="modal_open = true" class="flex cursor-pointer items-center gap-2 mb-4 bg-indigo-600 text-white py-2 px-4 hover:bg-indigo-900 rounded-full p-2">
            Nova Conversa
        </button>
        <ul id="conversations-list" class="flex flex-col gap-1 divide-y mt-2">
            {% include 'a_inbox/my_conversations.html' %}
        </ul>
    </div>
    
    <!-- Modal for Search User -->
    <div x-show="modal_open" x-cloak class="fixed inset-0 z-50 overflow-hidden bg-gray-500 bg-opacity-75 flex items-center justify-center">
        <div class="relative w-full max-w-lg h-[50vh] overflow-hidden rounded-2xl bg-white shadow-lg">
            <div class="flex items-center justify-between px-4 py-5 sm:px-6">
                <button @click="modal_open = false" class="text-gray-500 hover:text-gray-700 focus:outline-none">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="px-4 pb-4 pt-2 sm:p-6 h-full overflow-auto">
                {% include 'a_inbox/form_searchuser.html' %}
            </div>
        </div>
    </div>
    
    <!-- Messages Section -->
    <div id="conversation" class="w-full md:w-2/3 bg-white shadow-lg rounded-lg p-4 relative overflow-y-auto opacity-0"
        _="on load wait for 5ms then remove .opacity-0">

        {% if conversation %}
            <div class="text-center flex flex-col items-center">
                {% for participant in conversation.participants.all %}
                {% if participant != request.user %}
                <a href="{% url 'userprofile' participant.username %}">
                    <img class="w-10 h-10 rounded-full object-cover mb-4" src="{{ participant.profile.avatar }}" alt="Profile Image">
                </a>
                <div class="text-center max-w-md">
                    <h1 class="text-lg mb-2">{{ participant.profile.name }}</h1>
                    <div class="text-gray-400 text-sm">@{{ participant.username }}</div>
                </div>
                {% endif %}
                {% endfor %}
            </div>    

            <ul id="inbox_messages" class="flex flex-col justify-end gap-6 p-4 sm:p-10 pb-0">
                {% for message in conversation.messages.all reversed %}
                <li>
                    <div class="flex flex-col md:flex-row gap-1 md:gap-6">
                        <a class="contents" href="{% url 'userprofile' message.sender.username %}">
                            <img class="w-10 h-10 object-cover rounded-full" src="{{ message.sender.profile.avatar }}" alt="Profile Image">
                        </a>
                        <div class="bg-white p-4 w-full rounded-xl border-2 border-gray-200 max-w-21">
                            <div class="flex flex-col md:flex-row justify-between text-xs pb-3 text-zinc-500">
                                <div>
                                    <span class="font-bold text-base text-black mr-1">{{ message.sender.profile.name }}</span>@{{ message.sender.username }}
                                </div>
                                <div>{{ message.created|date:"M d, Y, H:iA" }} ({{ message.created|timesince }} ago)</div>
                            </div>
                            <div class="break-words">
                                {{ message.body_decrypted }}
                            </div>
                        </div>
                    </div>
                </li>
                {% empty %}
                <li>Nenhuma mensagem nesta conversa.</li>
                {% endfor %}
                <!-- Botão Responder -->
                <button class="reply-button mt-2 text-blue-500" data-conversation-id="{{ conversation.id }}">Conversar</button>
            </ul>

            <!-- Container para o Formulário de Nova Resposta -->
            <div id="new-reply-container" class="sticky bottom-0 z-1 pl-4 sm:pl-10 pt-6 pb-10 flex bg-white"></div>
        {% else %}
        <div class="h-full flex items-center justify-center text-gray-500 -mt-6 text-center p-10"> 
            Selecione uma conversa ou crie uma nova
        </div>
        {% endif %}
    </div>
</div>

<!-- Script para rolar automaticamente para o final da conversa e carregar o formulário de resposta -->
<script>
    function scrollToBottom() {
        const container = document.getElementById('conversation');
        container.scrollTop = container.scrollHeight;
    }

    window.onload = function() {
        scrollToBottom();
    };

    document.addEventListener('DOMContentLoaded', function() {
        const replyButtons = document.querySelectorAll('.reply-button');
        const replyContainer = document.getElementById('new-reply-container');

        replyButtons.forEach(button => {
            button.addEventListener('click', function(event) {
                event.preventDefault();
                const conversationId = this.getAttribute('data-conversation-id');
                const url = "{% url 'inbox-newreply' 'placeholder' %}".replace('placeholder', conversationId);
                fetch(url)
                    .then(response => response.text())
                    .then(html => {
                        replyContainer.innerHTML = html;
                        scrollToBottom();
                    })
                    .catch(error => console.error('Error loading reply form:', error));
            });
        });
    });
</script>
{% endblock %}
